parameters:
  - name: ProjectList
    type: string
  - name: CheckoutRecordings
    type: boolean
    default: false

steps:
  - task: PythonScript@0
    displayName: 'Generate directories variable for sparse checkout'
    inputs:
      scriptPath: 'eng/scripts/generate_from_source_pom.py'
      arguments: '--set-pipeline-variable --project-list ${{ parameters.ProjectList }}'
      workingDirectory: '$(System.DefaultWorkingDirectory)'

  - template: /eng/common/pipelines/templates/sparse-checkout.yml
    parameters:
      Paths: $(CheckoutDirectories)

  - pwsh: |
      $paths = ('$(CheckoutDirectories)' | ConvertFrom-Json) -join ' '
      $command = "git sparse-checkout set eng '**/*.xml' '**/*.md' '**/test-resources.json' $paths"
      if (!$${{ parameters.CheckoutRecordings }}) {
        $command += " '!/**/session-records/*/.json'"
        $command += " '!/**/test-recordings/*/.json'"
      }
      Write-Host $command
      Invoke-Expression -Command $command
      Write-Host "Set sparse checkout paths to:"
      Get-Content .git/info/sparse-checkout
    displayName: Sparse checkout module paths
