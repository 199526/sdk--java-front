parameters:
  - name: ProjectList
    type: string
  - name: CheckoutRecordings
    type: boolean
    default: false

steps:
  - task: PythonScript@0
    displayName: 'Generate directories variable for sparse checkout'
    inputs:
      scriptPath: 'eng/scripts/generate_from_source_pom.py'
      arguments: '--set-pipeline-variable --project-list ${{ parameters.ProjectList }}'
      workingDirectory: '$(System.DefaultWorkingDirectory)'

  - pwsh: |
      $paths = ('$(CheckoutDirectories)' | ConvertFrom-Json) -join ' '
      $javaPaths = $paths | ForEach-Object { $_ + '/**/*.java' }
      $jsonPaths = $paths | ForEach-Object { $_ + '/**/*.json' }
      if (!$${{ parameters.CheckoutRecordings }}) {
        $excludePaths = $paths | ForEach-Object {
          ("!" + $_ + '/**/session-records/*.json'), ("!" + $_ + '/**/test-recordings/*.json')
        }
      }
      Invoke-Expression -Command "git sparse-checkout set eng '**/*.xml' '**/*.md' '**/test-resources.json' $javaPaths $jsonPaths $excludePaths"
      Write-Host "Set sparse checkout paths to:"
      Get-Content .git/info/sparse-checkout
    displayName: Sparse checkout module paths
