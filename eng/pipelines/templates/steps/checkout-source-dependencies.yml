parameters:
  - name: ProjectList
    type: string
  - name: CheckoutRecordings
    type: boolean
    default: false

steps:
  - task: PythonScript@0
    displayName: 'Generate directories variable for sparse checkout'
    inputs:
      scriptPath: 'eng/scripts/generate_from_source_pom.py'
      arguments: '--set-pipeline-variable --project-list ${{ parameters.ProjectList }}'
      workingDirectory: '$(System.DefaultWorkingDirectory)'

  - pwsh: |
      $paths = ('$(CheckoutDirectories)' | ConvertFrom-Json) -join ' '
      $javaPaths = $paths | ForEach-Object { "$_ + '/**/*.java'" }
      $jsonPaths = $paths | ForEach-Object { "$_ + '/**/*.json'" }
      $command = "git sparse-checkout set eng '**/*.xml' '**/*.md' '**/test-resources.json' $javaPaths $jsonPaths"
      if (!$${{ parameters.CheckoutRecordings }}) {
        $command += '/**/session-records/*/.json'
        $command += '/**/test-recordings/*/.json'
      }
      Invoke-Expression -Command $command
      Write-Host "Set sparse checkout paths to:"
      Get-Content .git/info/sparse-checkout
    displayName: Sparse checkout module paths
